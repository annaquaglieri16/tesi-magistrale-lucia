---
title: "Effetto della quarantena e attivita' fisica sul benessere umorale"
author: "Anna Quaglieri"
date: "31/05/2020"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(readr)
library(tidyverse)
library(googledrive)
library(here)
library(ggalluvial)
library(modelsummary)
library(gridExtra)
library(epitools)
library(readxl)
library(ggExtra)

library(ggmap)
library(maps)
library(mapproj)
library(viridis)
library(ggrepel)
```


```{r read-data}
risposte <- read_csv(file.path(here(),"data/risposte-con-regioni.csv"))
```

* Crea nuova variabile per cambio in attivita'

```{r}
risposte <- risposte %>%
  mutate(pratica = case_when(ex_pre_si_no == "Si" & ex_durante_si_mp == "Si" ~ "continuato",
                             ex_pre_si_no == "Si" & ex_durante_si_mp == "No" ~ "smesso",
                             ex_pre_si_no == "No" & ex_durante_si_mp == "No" ~ "mai praticato",
                             ex_pre_si_no == "No" & ex_durante_si_mp == "Si" ~ "iniziato"), 
         pratica_durante = case_when(ex_pre_si_no == "Si" & ex_durante_si_mp == "Si" ~ "Si",
                             ex_pre_si_no == "Si" & ex_durante_si_mp == "No" ~ "No",
                             ex_pre_si_no == "No" & ex_durante_si_mp == "No" ~ "No",
                             ex_pre_si_no == "No" & ex_durante_si_mp == "Si" ~ "Si"), ) %>%
  mutate(pratica = factor(pratica, levels = c("continuato", "smesso", "mai praticato", "iniziato")))
```

# Analisi univariata

Inizialmente ho ricodificato le risposte sullo stato umorale in numeri per vedere se c'e' stata una diminuzione o aumento generale. La ricodifica e' stata fatta in questo modo:

- Mai = 0
- Raramente = 1
- Ogni tanto = 2
- Spesso = 3
- Ogni giorno = 4

```{r numeric-variables}
umori <- c("ansia", "tristezza", "stress", "rabbia", "felicita", "entusiasmo", "calma", "soddisfazione")
var_pre <- paste0(umori, "_pre")
var_durante <- paste0(umori, "_durante")
positive <- c("felicita", "entusiasmo", "calma", "soddisfazione")
negative <- c("ansia", "tristezza", "stress", "rabbia")

risposte_var_numeric <- risposte %>%
  mutate_at(.vars = c(var_pre, var_durante),
      funs(case_when(
    . == "Mai" ~ 0,
    . == "Raramente" ~ 1,
     . == "Ogni tanto" ~ 2,
     . == "Spesso" ~ 3,
     . == "Ogni giorno" ~ 4)))
```

## C'e' stata una diminuzione o aumento in generale dei diversi tipi di umore?

```{r differenze}
risposte_var_numeric <- risposte_var_numeric %>%
  mutate(ansia = ansia_durante - ansia_pre,
         tristezza = tristezza_durante - tristezza_pre,
         stress = stress_durante - stress_pre,
         rabbia = rabbia_durante - rabbia_pre,
         felicita = felicita_durante - felicita_pre,
         entusiasmo = entusiasmo_durante - entusiasmo_pre,
         calma = calma_durante - calma_pre,
         soddisfazione = soddisfazione_durante - soddisfazione_pre) %>%
  pivot_longer(ansia:soddisfazione, names_to = "Umore", values_to = "differenze_durante_prima") 

risposte_var_numeric <- risposte_var_numeric %>%
  mutate(classe_umore = ifelse(Umore %in% c("felicita", "entusiasmo",
                                               "calma", "soddisfazione"), "Umori positivi","Umori negativi"))
```


Dato che stiamo guardando alla differenza tra prima e dopo, si avranno valori negativi se **prima** della quarantena i partecipanti hanno messo valori piu' alti rispetto al **durante** per certi aspetti umorali e viceversa, valori positivi se **durante** e' maggiore di **prima**.

```{r grafico_differenza}
ggplot(risposte_var_numeric, aes(x = differenze_durante_prima)) + geom_bar() +
  facet_wrap(~Umore) + theme_classic()+ scale_x_continuous(breaks = seq(-4,4,1)) + labs(x = "Differenza in umore: Durante - Prima")+
  ggtitle("Valori positivi = la sensazione e' aumetata durante la quarantena\nValori negativi = la sensazione e' diminuita durante la quarantena")
```

```{r grafico_differenza_class}
ggplot(risposte_var_numeric, aes(x = differenze_durante_prima, fill = Umore)) + geom_bar() +
  facet_wrap(~classe_umore) + theme_classic() + 
  scale_x_continuous(breaks = seq(-4,4,1)) + labs(x = "Differenza in umore: Durante - Prima")+
  ggtitle("Valori positivi = la sensazione e' aumetata durante la quarantena\nValori negativi = la sensazione e' diminuita durante la quarantena")
```


## La differenza e' stata influenzata dalla pratica di attivita'?

In particolare dall'attivita' fisica. Nei grafici sotto, invece che mostrare i numeri totali delle persone mostro la proporzione dei livelli dei gruppi (diversi colori) nelle varie barre. 

```{r umore_pratica}
ggplot(risposte_var_numeric, aes(x = differenze_durante_prima, fill = pratica)) + geom_bar(position = "fill") +
  facet_wrap(~Umore) + theme_classic()+ scale_x_continuous(breaks = seq(-4,4,1)) + labs(x = "Differenza in umore: Durante - Prima")+
  ggtitle("Valori positivi = la sensazione e' aumetata durante la quarantena\nValori negativi = la sensazione e' diminuita durante la quarantena")
```

```{r umore_pratica_fill}
ggplot(risposte_var_numeric, aes(x = differenze_durante_prima, fill = pratica_durante)) + geom_bar(position = "fill") +
  facet_wrap(~Umore) + theme_classic()+ scale_x_continuous(breaks = seq(-4,4,1)) + labs(x = "Differenza in umore: Durante - Prima")+
  ggtitle("Valori positivi = la sensazione e' aumetata durante la quarantena\nValori negativi = la sensazione e' diminuita durante la quarantena")
```

```{r umore_pratica_01}
ggplot(risposte_var_numeric, aes(x = differenze_durante_prima, fill = pratica_durante)) + geom_bar() +
  facet_wrap(~Umore) + theme_classic()+ scale_x_continuous(breaks = seq(-4,4,1)) + labs(x = "Differenza in umore: Durante - Prima")+
  ggtitle("Valori positivi = la sensazione e' aumetata durante la quarantena\nValori negativi = la sensazione e' diminuita durante la quarantena")
```

## Modelli 

- Per ogni sensazione fai modello lineare con umore durante e pratica di attivita' e tipo abitazione, sesso, eta
- Per ogni sensazione fai modello multinomial con prima e dopo e pratica di attivita' (e tipo abitazione), sesso, eta

```{r modelli-univariati}

```


# Distribuzione geografica delle sensazioni 

Mostra la mappa dell'Italia con le varie sensazioni durante e la differenza tra prima e dopo


```{r load-geo}
# Get the world polygon and extract UK
italy <- map_data("world") %>% 
  filter(region=="Italy")

cities <- world.cities %>% 
  filter(country.etc=="Italy") %>%
  dplyr::rename(paese_residenza=name) %>%
  mutate(paese_residenza=tolower(paese_residenza))

# Regioni
province <- map_data("italy")
```

## In generale umori positivi vs umori negativi

```{r fig.height=12, fig.width=12}
risposte_by_city <- risposte %>%
  left_join(cities, by = c("comune" = "paese_residenza")) %>%
  group_by(comune, lat, long) %>%
  summarise(numero_risposte = n())

mybreaks <- round(seq(
  min(risposte_by_city$numero_risposte),
  max(risposte_by_city$numero_risposte), length.out = 5))

risposte_var_numeric <- risposte_var_numeric %>%
  left_join(cities, by = c("comune" = "paese_residenza")) %>%
  left_join(risposte_by_city)

ggplot() +
  geom_polygon(data = italy, aes(x= long, y = lat, group = group), fill="grey", alpha=0.3) +
  geom_point(data=risposte_var_numeric, aes(x= long, y= lat, 
            size = numero_risposte, colour=differenze_durante_prima), 
            shape=20, stroke=FALSE) +
  scale_size_continuous(name="Numero risposte", range=c(1,12), breaks = mybreaks) +
  #scale_color_viridis(name="Cambio in umore\nDurante-Prima", breaks = c(-3.6,0,3.6), labels = c("Diminuito","Invariato", "Cresciuto")) +
  scale_colour_gradient2(low = "#5e3c99", high = "#e66101", mid = "white", breaks = c(-3.6,0,3.6), labels = c("Diminuito","Invariato", "Cresciuto"))+
  theme_void() + coord_map() + 
  geom_text_repel(data=risposte_by_city %>% arrange(numero_risposte) %>% tail(20), 
                  aes(x=long, y=lat, label=toupper(comune)), size=2,
                  segment.size = 0.2)+
  ggtitle("Risposte per provincia") +
  theme(
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "white", color = NA), 
      panel.background = element_rect(fill = "white", color = NA), 
      legend.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(size= 16, hjust=0.1, color = "#4e4d47")) +
  facet_wrap(~classe_umore)
  #theme(legend.position = "bottom")
```


```{r barplots-classe-umore}
risposte_umore <- risposte_var_numeric %>%
  group_by(classe_umore, comune) %>%
  summarise(media = mean(differenze_durante_prima)) %>%
  mutate(comune = fct_reorder(comune, media))

ggplot(risposte_umore, aes(x = comune, y = media, fill = media)) + 
  geom_bar(stat= "identity")+
  facet_wrap(~classe_umore) +
  scale_fill_gradient2(low = "#5e3c99", high = "#e66101", mid = "white", 
                       limits = c(-4,4), breaks = c(-3.6,0,3.6), labels = c("Diminuito","Invariato", "Cresciuto"))+
  theme_classic() +
  coord_flip() +
  labs(x = "Comune", y = "Media differenza di umore Durante-Prima per comune")
```


## Umori singoli uno per uno


```{r barplots-umori-singoli}
risposte_umore <- risposte_var_numeric %>%
  group_by(Umore, regione) %>%
  summarise(media = mean(differenze_durante_prima)) %>%
  mutate(comune = fct_reorder(regione, media),
         Umore = factor(Umore, levels = c(positive, negative))) 

ggplot(risposte_umore, aes(x = regione, y = media, fill = media)) + 
  geom_bar(stat= "identity")+
  facet_wrap(~Umore) +
  scale_fill_gradient2(low = "#5e3c99", high = "#e66101", mid = "white", 
                       limits = c(-4,4), breaks = c(-3.6,0,3.6), labels = c("Diminuito","Invariato", "Cresciuto"))+
  theme_classic() +
  coord_flip() +
  labs(x = "Regione", y = "Media") + ggtitle("Media della differenza di umore Durante-Prima per regione")
```

